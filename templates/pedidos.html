{% extends "base.html" %}

{% block title %}Pedidos - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="page-title mb-0">Gestión de Pedidos</h2>
        <div class="d-flex gap-2">
            <div class="dropdown">
                <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-funnel me-2"></i>Filtrar por Estado
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{{ url_for('listar_pedidos') }}">Todos</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('listar_pedidos', estado='pendiente') }}">Pendientes</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('listar_pedidos', estado='procesando') }}">Procesando</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('listar_pedidos', estado='completado') }}">Completados</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('listar_pedidos', estado='cancelado') }}">Cancelados</a></li>
                </ul>
            </div>
        </div>
    </div>
    
    <div class="card" data-aos="fade-up">
        <div class="card-body">
            {% if pedidos %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Fecha</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pedido in pedidos %}
                        <tr>
                            <td><strong>#{{ pedido.id }}</strong></td>
                            <td>
                                <div>
                                    <strong>{{ pedido.cliente_nombre }}</strong><br>
                                    <small class="text-muted">{{ pedido.cliente_telefono }}</small>
                                </div>
                            </td>
                            <td>{{ pedido.fecha.strftime('%d/%m/%Y %H:%M') }}</td>
                            <td class="text-success fw-bold">${{ "%.2f"|format(pedido.total) }}</td>
                            <td>
                                <span class="badge bg-{% if pedido.estado == 'pendiente' %}warning{% elif pedido.estado == 'procesando' %}info{% elif pedido.estado == 'completado' %}success{% else %}danger{% endif %}">
                                    {{ pedido.estado.title() }}
                                </span>
                            </td>
                            <td>
                                <!-- Mejorando los botones de acciones para que sean más visibles -->
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="{{ url_for('ver_pedido', pedido_id=pedido.id) }}" 
                                    class="btn btn-outline-primary" title="Ver detalles">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    
                                    {% if pedido.estado == 'pendiente' %}
                                    <!-- Botón para editar pedido pendiente -->
                                    <a href="{{ url_for('editar_pedido', pedido_id=pedido.id) }}" 
                                    class="btn btn-outline-info" title="Editar pedido">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    {% endif %}
                                    
                                    {% if pedido.estado == 'pendiente' %}
                                    <button class="btn btn-outline-success" 
                                            onclick="cambiarEstado({{ pedido.id }}, 'procesando', this)" 
                                            title="Marcar como procesando">
                                        <i class="bi bi-arrow-repeat"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" 
                                            onclick="cambiarEstado({{ pedido.id }}, 'cancelado', this)" 
                                            title="Cancelar pedido">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                    {% elif pedido.estado == 'procesando' %}
                                    <button class="btn btn-outline-success" 
                                            onclick="verificarProductosPersonalizados({{ pedido.id }}, this)" 
                                            title="Completar pedido">
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                    <button class="btn btn-outline-warning" 
                                            onclick="cambiarEstado({{ pedido.id }}, 'pendiente', this)" 
                                            title="Volver a pendiente">
                                        <i class="bi bi-arrow-left-circle"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-cart display-1 text-muted mb-3"></i>
                <h4 class="text-muted">No hay pedidos registrados</h4>
                <p class="text-muted">Los pedidos aparecerán aquí cuando los clientes realicen compras</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Mejorando el script para manejar cambios de estado -->
<script>
function verificarProductosPersonalizados(pedidoId, buttonElement) {
    // Deshabilitar el botón inmediatamente para evitar múltiples clics
    const originalContent = buttonElement.innerHTML;
    buttonElement.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    buttonElement.disabled = true;
    
    fetch(`/api/pedido/${pedidoId}/productos-personalizados`)
    .then(response => response.json())
    .then(data => {
        if (data.productos_sin_precio && data.productos_sin_precio.length > 0) {
            alert(`No se puede completar el pedido. Los siguientes productos personalizados no tienen precio: ${data.productos_sin_precio.join(', ')}`);
            // Restaurar el botón
            buttonElement.innerHTML = originalContent;
            buttonElement.disabled = false;
        } else {
            cambiarEstado(pedidoId, 'completado', buttonElement);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Restaurar el botón y continuar
        buttonElement.innerHTML = originalContent;
        buttonElement.disabled = false;
        cambiarEstado(pedidoId, 'completado', buttonElement);
    });
}

function cambiarEstado(pedidoId, nuevoEstado, buttonElement) {
    let mensaje = '';
    let confirmacion = true;
    
    switch(nuevoEstado) {
        case 'procesando':
            mensaje = `¿Marcar el pedido #${pedidoId} como procesando?`;
            break;
        case 'completado':
            mensaje = `¿Completar el pedido #${pedidoId}? Esto creará automáticamente una deuda para el cliente.`;
            break;
        case 'cancelado':
            mensaje = `¿Cancelar el pedido #${pedidoId}? Esto restaurará el stock de los productos.`;
            break;
        case 'pendiente':
            mensaje = `¿Volver a marcar el pedido #${pedidoId} como pendiente?`;
            break;
        default:
            mensaje = `¿Cambiar estado del pedido #${pedidoId} a ${nuevoEstado}?`;
    }
    
    if (confirm(mensaje)) {
        // Si no se proporcionó buttonElement, buscar el botón más cercano
        let button = buttonElement;
        if (!button) {
            // Buscar el botón que inició la acción (para compatibilidad con versiones anteriores)
            button = document.querySelector(`button[onclick*="${pedidoId}"][onclick*="${nuevoEstado}"]`);
        }
        
        // Mostrar indicador de carga
        const originalContent = button ? button.innerHTML : '';
        if (button) {
            button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
            button.disabled = true;
        }
        
        fetch(`/cambiar_estado_pedido/${pedidoId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ estado: nuevoEstado })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar mensaje de éxito
                showAlert('success', data.message);
                // Recargar la página después de un breve delay
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                showAlert('danger', data.message || 'Error al cambiar el estado');
                if (button) {
                    button.innerHTML = originalContent;
                    button.disabled = false;
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('danger', 'Error de conexión al cambiar el estado');
            if (button) {
                button.innerHTML = originalContent;
                button.disabled = false;
            }
        });
    } else {
        // Si el usuario cancela, restaurar el botón
        if (buttonElement) {
            buttonElement.innerHTML = originalContent;
            buttonElement.disabled = false;
        }
    }
}

// Actualizar los botones para pasar la referencia del elemento
document.addEventListener('DOMContentLoaded', function() {
    // Para el botón de completar pedido
    document.querySelectorAll('button[onclick^="verificarProductosPersonalizados"]').forEach(button => {
        const originalOnClick = button.getAttribute('onclick');
        const match = originalOnClick.match(/verificarProductosPersonalizados\((\d+)\)/);
        if (match) {
            const pedidoId = match[1];
            button.setAttribute('onclick', `verificarProductosPersonalizados(${pedidoId}, this)`);
        }
    });
    
    // Para otros botones de cambiar estado
    document.querySelectorAll('button[onclick^="cambiarEstado"]').forEach(button => {
        const originalOnClick = button.getAttribute('onclick');
        const match = originalOnClick.match(/cambiarEstado\((\d+),\s*'([^']+)'\)/);
        if (match) {
            const pedidoId = match[1];
            const estado = match[2];
            button.setAttribute('onclick', `cambiarEstado(${pedidoId}, '${estado}', this)`);
        }
    });
});

// Resto del código sin cambios...
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Legacy function for compatibility
function changeStatus(pedidoId, newStatus) {
    cambiarEstado(pedidoId, newStatus);
}
</script>
{% endblock %}